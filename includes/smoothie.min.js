function TimeSeries(options){options=options||{};options.resetBoundsInterval=options.resetBoundsInterval||3000;options.resetBounds=options.resetBounds||true;this.options=options;this.data=[];this.maxValue=Number.NaN;this.minValue=Number.NaN;if(options.resetBounds){this.boundsTimer=setInterval(function(thisObj){thisObj.resetBounds();},options.resetBoundsInterval,this);}}
TimeSeries.prototype.resetBounds=function(){this.maxValue=Number.NaN;this.minValue=Number.NaN;for(var i=0;i<this.data.length;i++){this.maxValue=!isNaN(this.maxValue)?Math.max(this.maxValue,this.data[i][1]):this.data[i][1];this.minValue=!isNaN(this.minValue)?Math.min(this.minValue,this.data[i][1]):this.data[i][1];}};TimeSeries.prototype.append=function(timestamp,value){this.data.push([timestamp,value]);this.maxValue=!isNaN(this.maxValue)?Math.max(this.maxValue,value):value;this.minValue=!isNaN(this.minValue)?Math.min(this.minValue,value):value;};function SmoothieChart(options){options=options||{};options.grid=options.grid||{fillStyle:'#000000',strokeStyle:'#777777',lineWidth:1,millisPerLine:1000,verticalSections:2};options.millisPerPixel=options.millisPerPixel||20;options.fps=options.fps||50;options.maxValueScale=options.maxValueScale||1;options.minValue=options.minValue;options.maxValue=options.maxValue;options.labels=options.labels||{fillStyle:'#ffffff'};options.interpolation=options.interpolation||"bezier";options.scaleSmoothing=options.scaleSmoothing||0.125;this.options=options;this.seriesSet=[];this.currentValueRange=1;this.currentVisMinValue=0;}
SmoothieChart.prototype.addTimeSeries=function(timeSeries,options){this.seriesSet.push({timeSeries:timeSeries,options:options||{}});};SmoothieChart.prototype.removeTimeSeries=function(timeSeries){this.seriesSet.splice(this.seriesSet.indexOf(timeSeries),1);};SmoothieChart.prototype.streamTo=function(canvas,delay){var self=this;this.render_on_tick=function(){self.render(canvas,new Date().getTime()-(delay||0));};this.start();};SmoothieChart.prototype.start=function(){if(!this.timer)
this.timer=setInterval(this.render_on_tick,1000/this.options.fps);};SmoothieChart.prototype.stop=function(){if(this.timer){clearInterval(this.timer);this.timer=undefined;}};SmoothieChart.prototype.render=function(canvas,time){var canvasContext=canvas.getContext("2d");var options=this.options;var dimensions={top:0,left:0,width:canvas.clientWidth,height:canvas.clientHeight};canvasContext.save();time=time-time%options.millisPerPixel;canvasContext.translate(dimensions.left,dimensions.top);canvasContext.beginPath();canvasContext.rect(0,0,dimensions.width,dimensions.height);canvasContext.clip();canvasContext.save();canvasContext.fillStyle=options.grid.fillStyle;canvasContext.clearRect(0,0,dimensions.width,dimensions.height);canvasContext.fillRect(0,0,dimensions.width,dimensions.height);canvasContext.restore();canvasContext.save();canvasContext.lineWidth=options.grid.lineWidth||1;canvasContext.strokeStyle=options.grid.strokeStyle||'#ffffff';if(options.grid.millisPerLine>0){for(var t=time-(time%options.grid.millisPerLine);t>=time-(dimensions.width*options.millisPerPixel);t-=options.grid.millisPerLine){canvasContext.beginPath();var gx=Math.round(dimensions.width-((time-t)/options.millisPerPixel));canvasContext.moveTo(gx,0);canvasContext.lineTo(gx,dimensions.height);canvasContext.stroke();canvasContext.closePath();}}
for(var v=1;v<options.grid.verticalSections;v++){var gy=Math.round(v*dimensions.height/options.grid.verticalSections);canvasContext.beginPath();canvasContext.moveTo(0,gy);canvasContext.lineTo(dimensions.width,gy);canvasContext.stroke();canvasContext.closePath();}
canvasContext.beginPath();canvasContext.strokeRect(0,0,dimensions.width,dimensions.height);canvasContext.closePath();canvasContext.restore();var maxValue=Number.NaN;var minValue=Number.NaN;for(var d=0;d<this.seriesSet.length;d++){var timeSeries=this.seriesSet[d].timeSeries;if(!isNaN(timeSeries.maxValue)){maxValue=!isNaN(maxValue)?Math.max(maxValue,timeSeries.maxValue):timeSeries.maxValue;}
if(!isNaN(timeSeries.minValue)){minValue=!isNaN(minValue)?Math.min(minValue,timeSeries.minValue):timeSeries.minValue;}}
if(isNaN(maxValue)&&isNaN(minValue)){return;}
if(options.maxValue!=null)
maxValue=options.maxValue;else
maxValue=maxValue*options.maxValueScale;if(options.minValue!=null)
minValue=options.minValue;var targetValueRange=maxValue-minValue;this.currentValueRange+=options.scaleSmoothing*(targetValueRange-this.currentValueRange);this.currentVisMinValue+=options.scaleSmoothing*(minValue-this.currentVisMinValue);var valueRange=this.currentValueRange;var visMinValue=this.currentVisMinValue;for(var d=0;d<this.seriesSet.length;d++){canvasContext.save();var timeSeries=this.seriesSet[d].timeSeries;var dataSet=timeSeries.data;var seriesOptions=this.seriesSet[d].options;while(dataSet.length>=2&&dataSet[1][0]<time-(dimensions.width*options.millisPerPixel)){dataSet.splice(0,1);}
canvasContext.lineWidth=seriesOptions.lineWidth||1;canvasContext.fillStyle=seriesOptions.fillStyle;canvasContext.strokeStyle=seriesOptions.strokeStyle||'#ffffff';canvasContext.beginPath();var firstX=0,lastX=0,lastY=0;for(var i=0;i<dataSet.length;i++){var x=Math.round(dimensions.width-((time-dataSet[i][0])/options.millisPerPixel));var value=dataSet[i][1];var offset=value-visMinValue;var scaledValue=dimensions.height-(valueRange?Math.round((offset/valueRange)*dimensions.height):0);var y=Math.max(Math.min(scaledValue,dimensions.height-1),1);if(i==0){firstX=x;canvasContext.moveTo(x,y);}
else{switch(options.interpolation){case"line":canvasContext.lineTo(x,y);break;case"bezier":default:canvasContext.bezierCurveTo(Math.round((lastX+x)/2),lastY,Math.round((lastX+x))/2,y,x,y);break;}}
lastX=x,lastY=y;}
if(dataSet.length>0&&seriesOptions.fillStyle){canvasContext.lineTo(dimensions.width+seriesOptions.lineWidth+1,lastY);canvasContext.lineTo(dimensions.width+seriesOptions.lineWidth+1,dimensions.height+seriesOptions.lineWidth+1);canvasContext.lineTo(firstX,dimensions.height+seriesOptions.lineWidth);canvasContext.fill();}
canvasContext.stroke();canvasContext.closePath();canvasContext.restore();}
if(!options.labels.disabled){canvasContext.fillStyle=options.labels.fillStyle;var maxValueString=parseFloat(maxValue).toFixed(2);var minValueString=parseFloat(minValue).toFixed(2);canvasContext.fillText(maxValueString,dimensions.width-canvasContext.measureText(maxValueString).width-2,10);canvasContext.fillText(minValueString,dimensions.width-canvasContext.measureText(minValueString).width-2,dimensions.height-2);}
canvasContext.restore();}